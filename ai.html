<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline';">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Assistant</title>
    <link rel="stylesheet" href="./style.css">
    <script src="./marked.min.js"></script>
</head>
<br>
<div>
    <img id="preview" style="width: 50%;">
</div>
<br>
<div id="actions" style="display: none;">
<p>QUICK ACTIONS:</p>
</div><br>
<div id="customactions" style="display: none;">
<p>CUSTOM PROMPT:</p>
<textarea style="width: 100%;" id="custom" placeholder="Enter your custom prompt here..."></textarea><br><br>
<button style="width: 50%;margin: auto; display: block;" id="send">Send</button>
</div>

<div id="response" style="display: none;"></div>
<br>
<button id="new-question" style="display: none;width: 100%;" onclick="location.reload()">New Question</button>

<details id="thinking" style="margin-top: 1rem;display: none;">
    <summary>Thinking Details</summary>
    <div id="thinking-details" style="padding: 1rem; background: rgba(255, 255, 255, 0.1); border-radius: 5px; margin-top: 0.5rem;"></div>
</details><br>

<script>

window.electronAPI.onCaptureComplete(dataUrl => {
    console.log('Received capture result:', dataUrl);
    const preview = document.getElementById('preview');

    preview.src = dataUrl;
    preview.style.display = 'block';

    console.log('Received capture result:', dataUrl);
});

const hideActionsAndShowResponse = () => {
    document.getElementById('actions').style.display = 'none';
    document.getElementById('customactions').style.display = 'none';
    const responseBox = document.getElementById('response');
    responseBox.style.display = 'block';
    responseBox.innerHTML = 'Loading...';
    document.getElementById('thinking').style.display = 'block';
};

window.electronAPI.getShortcuts().then(shortcuts => {
    const actionsDiv = document.getElementById('actions');
    Object.keys(shortcuts).forEach((shortcut, i) => {
        const btn = document.createElement('button');
        btn.textContent = shortcut;
        btn.onclick = () => {
            window.electronAPI.sendPrompt(shortcuts[shortcut]);
            hideActionsAndShowResponse();
        };
        actionsDiv.appendChild(btn);
    });
});

document.getElementById('send').addEventListener('click', () => {
    const prompt = document.getElementById('custom').value;
    if (prompt.trim()) {
        window.electronAPI.sendPrompt(prompt);
        hideActionsAndShowResponse();
    }
});

let aiResponseBuffer = '';
let lastMessageType = null;

window.electronAPI.onResponse((message) => {
const responseBox = document.getElementById('response');
const thinkingDetails = document.getElementById('thinking-details');
  if(message.type == 'done') {
    document.getElementById('new-question').style.display = 'block';
    return;
  }
  if (responseBox.innerHTML === 'Loading...' && message.type === 'message') {
    responseBox.innerHTML = '';
    aiResponseBuffer = '';
    lastMessageType = null;
  }

  console.log('Received AI response chunk:', message);

  if (message.type !== lastMessageType) {
    aiResponseBuffer = '';
    lastMessageType = message.type;
  }

  aiResponseBuffer += message.message;

  const targetBox = (message.type === 'message' ? responseBox : thinkingDetails);
  targetBox.innerHTML = marked.parse(aiResponseBuffer);
});

window.electronAPI.onReady(() => {
document.getElementById('actions').style.display = 'block';
document.getElementById('customactions').style.display = 'block';
});

</script>