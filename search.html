<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline';">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Assistant</title>
    <link rel="stylesheet" href="./style.css">
    <script src="./marked.min.js"></script>
</head>
<br>
<div id="customactions">
<p>SEARCH FOR:</p>
<textarea style="width: 100%;" id="custom" placeholder="Enter natural language query here..."></textarea><br><br>
<button style="width: 50%;margin: auto; display: block;" id="send">Search</button>
</div>
<br><br>
<div id="response" style="display: none;"></div>
<br><br>
<div style="border: none; background: none;" id="followups"></div>
<button id="follow-up" style="display: none; width: 96%; margin: auto;" onclick="followUp()">Ask a follow-up question</button>

<script>

let chat = []

let responseBox = document.getElementById('response');


document.getElementById('send').addEventListener('click', () => {
    if(chat.length) return location.reload();
    const prompt = document.getElementById('custom').value;
    chat.push({ role: 'user', content: prompt });
    window.electronAPI.search(prompt);
      document.getElementById('response').style.display = 'block';
      document.getElementById('response').innerHTML = 'Searching...';
});

let aiResponseBuffer = '';
let lastMessageType = null;

window.electronAPI.onSearchResults((message) => {
  // Use 'responseBox' which now points to the latest box created
  if (!responseBox) return; 

  if (message.type === 'done') {
    chat.push({ role: 'assistant', content: aiResponseBuffer });
    document.getElementById('follow-up').style.display = 'block';
    responseBox.innerHTML = marked.parse(aiResponseBuffer);
    return;
  }

  // Handle the object structure used by follow-up
  const textChunk = typeof message === 'object' ? message.message : message;
  aiResponseBuffer += textChunk;
  
  responseBox.innerHTML = marked.parse(aiResponseBuffer);
});

const followUp = async () => {
  aiResponseBuffer = ''; 
  
  const newBox = document.createElement('div');
  newBox.id = 'response-' + Math.random().toString(36).substring(2, 15);
  newBox.style.marginTop = '10px';
  newBox.style.padding = '10px';
  newBox.innerHTML = 'Loading...';
  
  document.getElementById('followups').appendChild(newBox);
  
  responseBox = newBox; 

  const userPrompt = await window.electronAPI.followUp(chat); 
  if (!userPrompt) return;

  chat.push({ role: 'user', content: userPrompt });
}

</script>